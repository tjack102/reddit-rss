<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The TV Signal â€” {{ date }}</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        line-height: 1.6;
        color: #e0e0e0;
        background: #0d1117;
        padding: 16px;
        max-width: 720px;
        margin: 0 auto;
      }

      /* --- Header --- */
      .header {
        text-align: center;
        padding: 32px 0 20px;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        margin-bottom: 24px;
      }
      .header h1 {
        font-size: 32px;
        font-weight: 800;
        color: #fff;
        letter-spacing: -0.5px;
      }
      .header .tagline {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
        font-style: italic;
      }
      .header .date {
        font-size: 14px;
        color: #9ca3af;
        margin-top: 8px;
      }
      .header .last-updated {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
      }

      /* --- Stats Dashboard (#6) --- */
      .stats-dashboard {
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        padding: 16px 20px;
        margin-bottom: 24px;
        backdrop-filter: blur(10px);
      }
      .stats-dashboard h3 {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #6b7280;
        margin-bottom: 12px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      .stat-item {
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
        padding: 10px 12px;
      }
      .stat-value {
        font-size: 22px;
        font-weight: 700;
        color: #fff;
      }
      .stat-label {
        font-size: 11px;
        color: #6b7280;
        margin-top: 2px;
      }
      .stat-hottest {
        grid-column: 1 / -1;
        font-size: 12px;
        color: #9ca3af;
        padding: 8px 12px;
        background: rgba(255,255,255,0.03);
        border-radius: 8px;
      }
      .stat-hottest strong { color: #f59e0b; }

      /* --- Controls bar (#4, #24) --- */
      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 20px;
        align-items: center;
      }
      .controls-section {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
      }
      .controls-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6b7280;
        margin-right: 4px;
      }
      .filter-btn, .mode-btn {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.1);
        color: #9ca3af;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .filter-btn:hover, .mode-btn:hover {
        background: rgba(255,255,255,0.1);
        color: #e0e0e0;
      }
      .filter-btn.active, .mode-btn.active {
        background: rgba(99,102,241,0.2);
        border-color: rgba(99,102,241,0.4);
        color: #a5b4fc;
      }

      /* --- My Shows panel (#22) --- */
      .my-shows-panel {
        background: rgba(251,191,36,0.06);
        border: 1px solid rgba(251,191,36,0.15);
        border-radius: 12px;
        padding: 14px 18px;
        margin-bottom: 20px;
        display: none;
      }
      .my-shows-panel.visible { display: block; }
      .my-shows-panel h3 {
        font-size: 13px;
        color: #fbbf24;
        margin-bottom: 8px;
      }
      .my-shows-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .my-show-tag {
        background: rgba(251,191,36,0.12);
        border: 1px solid rgba(251,191,36,0.2);
        color: #fbbf24;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 12px;
        cursor: pointer;
      }
      .my-show-tag:hover { background: rgba(251,191,36,0.2); }

      /* --- Bookmarks panel (#36) --- */
      .bookmarks-panel {
        background: rgba(99,102,241,0.06);
        border: 1px solid rgba(99,102,241,0.15);
        border-radius: 12px;
        padding: 14px 18px;
        margin-bottom: 20px;
        display: none;
      }
      .bookmarks-panel.visible { display: block; }
      .bookmarks-panel h3 {
        font-size: 13px;
        color: #a5b4fc;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .bookmark-export-btn {
        font-size: 11px;
        background: rgba(99,102,241,0.15);
        border: 1px solid rgba(99,102,241,0.3);
        color: #a5b4fc;
        padding: 2px 10px;
        border-radius: 10px;
        cursor: pointer;
      }
      .bookmarks-list { font-size: 13px; }
      .bookmarks-list a {
        color: #a5b4fc;
        text-decoration: none;
        display: block;
        padding: 4px 0;
      }
      .bookmarks-list a:hover { color: #c4b5fd; }

      /* --- Degraded notice --- */
      .degraded-notice {
        background: rgba(251,191,36,0.1);
        border: 1px solid rgba(251,191,36,0.3);
        border-radius: 10px;
        padding: 12px 16px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #fbbf24;
      }

      /* --- Post cards --- */
      .post {
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 14px;
        padding: 20px;
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
        transition: border-color 0.2s;
        position: relative;
      }
      .post:hover { border-color: rgba(255,255,255,0.15); }
      .post.tracked-show { border-left: 3px solid #fbbf24; }
      .post.read-post { opacity: 0.45; }
      .post.read-post .post-title { text-decoration: line-through; }
      .post.hidden-post { display: none; }

      /* Spoiler blur (#20) */
      .post.spoiler-post .spoiler-content { filter: blur(6px); transition: filter 0.3s; }
      .post.spoiler-post .spoiler-content.revealed { filter: none; }
      .spoiler-banner {
        background: rgba(239,68,68,0.15);
        border: 1px solid rgba(239,68,68,0.3);
        color: #fca5a5;
        font-size: 12px;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .spoiler-toggle {
        font-size: 11px;
        color: #9ca3af;
        cursor: pointer;
        margin-left: 8px;
        text-decoration: underline;
      }

      /* Trending badge (#3) */
      .trending-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: rgba(239,68,68,0.15);
        border: 1px solid rgba(239,68,68,0.3);
        color: #fca5a5;
        font-size: 11px;
        font-weight: 600;
        padding: 2px 10px;
        border-radius: 12px;
        animation: pulse-badge 2s infinite;
        margin-bottom: 8px;
      }
      @keyframes pulse-badge {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }

      .post-title {
        font-size: 20px;
        font-weight: 700;
        color: #fff;
        text-decoration: none;
        display: block;
        margin-bottom: 8px;
        line-height: 1.3;
      }
      .post-title:hover { color: #a5b4fc; }

      .post-meta {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 12px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
      }

      /* Comment count badges (#1) */
      .badge-comments {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 1px 8px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 12px;
      }
      .badge-500 { background: rgba(239,68,68,0.2); color: #fca5a5; }
      .badge-100 { background: rgba(249,115,22,0.2); color: #fdba74; }
      .badge-50  { background: rgba(59,130,246,0.2); color: #93c5fd; }

      /* Flair tags (#1) */
      .flair {
        display: inline-block;
        background: rgba(99,102,241,0.15);
        color: #a5b4fc;
        padding: 1px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        border: 1px solid rgba(99,102,241,0.25);
      }

      /* Sentiment badge (#7) */
      .sentiment-badge {
        font-size: 11px;
        padding: 1px 8px;
        border-radius: 10px;
        font-weight: 500;
      }
      .sentiment-positive { background: rgba(34,197,94,0.15); color: #86efac; }
      .sentiment-negative { background: rgba(239,68,68,0.15); color: #fca5a5; }
      .sentiment-mixed    { background: rgba(249,115,22,0.15); color: #fdba74; }
      .sentiment-neutral   { background: rgba(107,114,128,0.15); color: #9ca3af; }

      /* Consensus badge (#26) */
      .consensus-badge {
        font-size: 11px;
        padding: 1px 8px;
        border-radius: 10px;
        font-weight: 500;
      }
      .consensus-consensus { background: rgba(34,197,94,0.15); color: #86efac; }
      .consensus-divided   { background: rgba(249,115,22,0.15); color: #fdba74; }

      /* Reading time (#23) */
      .reading-time {
        font-size: 11px;
        color: #6b7280;
      }

      /* Action buttons (#8) */
      .post-actions {
        display: flex;
        gap: 6px;
        margin-top: 12px;
      }
      .action-btn {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        color: #6b7280;
        padding: 4px 12px;
        border-radius: 8px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .action-btn:hover { background: rgba(255,255,255,0.1); color: #e0e0e0; }
      .action-btn.active { color: #a5b4fc; border-color: rgba(99,102,241,0.3); }
      .track-btn.active { color: #fbbf24; border-color: rgba(251,191,36,0.3); }

      /* --- Comments section (#2) --- */
      .comments-section {
        border-top: 1px solid rgba(255,255,255,0.06);
        padding-top: 14px;
        margin-top: 14px;
      }
      .comments-count-label {
        font-size: 11px;
        color: #6b7280;
        margin-bottom: 10px;
      }

      .comment {
        padding: 10px 14px;
        border-left: 3px solid rgba(99,102,241,0.4);
        margin-bottom: 10px;
        font-size: 14px;
        background: rgba(255,255,255,0.02);
        border-radius: 0 8px 8px 0;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      }
      .comment-meta {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .comment-score { color: #86efac; }
      .comment-body {
        color: #d1d5db;
        word-wrap: break-word;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      /* Catalyst comment (#19) */
      .comment.catalyst {
        border-left-color: #fbbf24;
        background: rgba(251,191,36,0.04);
      }
      .catalyst-label {
        font-size: 11px;
        font-weight: 600;
        color: #fbbf24;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-bottom: 4px;
      }

      /* Creator comment (#34) */
      .comment.creator {
        border-left-color: #a855f7;
        background: rgba(168,85,247,0.06);
      }
      .creator-label {
        font-size: 11px;
        font-weight: 600;
        color: #a855f7;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-bottom: 4px;
      }

      /* --- Footer --- */
      .footer {
        text-align: center;
        padding: 28px 0 16px;
        font-size: 12px;
        color: #4b5563;
        border-top: 1px solid rgba(255,255,255,0.06);
        margin-top: 8px;
      }
      .footer a { color: #6b7280; text-decoration: none; }
      .footer a:hover { color: #9ca3af; }
      .footer .impact {
        font-size: 11px;
        color: #4b5563;
        margin-bottom: 12px;
        line-height: 1.6;
      }
      .footer .social-proof {
        font-size: 11px;
        color: #4b5563;
        margin-top: 8px;
      }

      /* --- Difficulty modes (#24) --- */
      .mode-quick .comment:nth-child(n+2) { display: none; }
      .mode-quick .comment-body { -webkit-line-clamp: 2; }
      .mode-deep .comment-body { -webkit-line-clamp: unset; overflow: visible; }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>The TV Signal</h1>
      <div class="tagline">Cutting through Reddit's noise since January 2026</div>
      <div class="date">{{ date }}</div>
      <div class="last-updated">Last updated {{ generated_at }}</div>
    </div>

    {% if degraded %}
    <div class="degraded-notice">
      Warning: Comments are temporarily unavailable. This digest shows thread metadata only. Normal service will resume with the next run.
    </div>
    {% endif %}

    {# --- Stats Dashboard (#6) --- #}
    {% if posts | length > 0 %}
    <div class="stats-dashboard">
      <h3>Today's Digest</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value">{{ posts | length }}</div>
          <div class="stat-label">Discussions found</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ "{:,}".format(total_comments) }}</div>
          <div class="stat-label">Total comments</div>
        </div>
        {% if posts_filtered_out > 0 %}
        <div class="stat-item">
          <div class="stat-value">{{ posts_filtered_out }}</div>
          <div class="stat-label">Noise posts filtered</div>
        </div>
        {% endif %}
        {% if hottest_title %}
        <div class="stat-hottest">
          Hottest: <strong>{{ hottest_title | truncate(50) }}</strong> ({{ "{:,}".format(hottest_comments) }} comments)
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {# --- Controls (#4 Smart Filtering + #24 Difficulty Modes) --- #}
    <div class="controls">
      <div class="controls-section" id="flair-filters">
        <span class="controls-label">Filter:</span>
        <button class="filter-btn active" data-flair="all" onclick="filterByFlair('all')">All</button>
      </div>
      <div class="controls-section">
        <span class="controls-label">Mode:</span>
        <button class="mode-btn" data-mode="quick" onclick="setMode('quick')">Quick Hits</button>
        <button class="mode-btn active" data-mode="standard" onclick="setMode('standard')">Standard</button>
        <button class="mode-btn" data-mode="deep" onclick="setMode('deep')">Deep Dive</button>
      </div>
    </div>

    {# --- My Shows Panel (#22) --- #}
    <div class="my-shows-panel" id="my-shows-panel">
      <h3>My Shows</h3>
      <div class="my-shows-list" id="my-shows-list"></div>
    </div>

    {# --- Bookmarks Panel (#36) --- #}
    <div class="bookmarks-panel" id="bookmarks-panel">
      <h3>
        <span>Bookmarks</span>
        <button class="bookmark-export-btn" onclick="exportBookmarks()">Export CSV</button>
      </h3>
      <div class="bookmarks-list" id="bookmarks-list"></div>
    </div>

    {# --- Post cards --- #}
    {% for post in posts %}
    <div class="post{% if post.has_spoiler %} spoiler-post{% endif %}"
         id="post-{{ post.id }}"
         data-flair="{{ post.flair | lower }}"
         data-show-name="{{ post.show_name }}"
         data-post-id="{{ post.id }}"
         data-title="{{ post.title }}"
         data-url="{{ post.url }}"
         data-comments="{{ post.num_comments }}">

      {# Trending badge (#3) #}
      {% if post.is_trending %}
      <div class="trending-badge">TRENDING NOW</div>
      {% endif %}

      {# Spoiler banner (#20) #}
      {% if post.has_spoiler %}
      <div class="spoiler-banner">
        Warning: Spoilers
        <span class="spoiler-toggle" onclick="toggleSpoiler(this)">Show anyway</span>
      </div>
      {% endif %}

      <div class="{% if post.has_spoiler %}spoiler-content{% endif %}">
        <a class="post-title" href="{{ post.url }}" target="_blank">{{ post.title }}</a>

        <div class="post-meta">
          <span>&#9650; {{ post.score }}</span>

          {# Comment count badge (#1) #}
          {% if post.num_comments >= 500 %}
          <span class="badge-comments badge-500">{{ post.num_comments }}</span>
          {% elif post.num_comments >= 100 %}
          <span class="badge-comments badge-100">{{ post.num_comments }}</span>
          {% else %}
          <span class="badge-comments badge-50">{{ post.num_comments }}</span>
          {% endif %}

          <span>by {{ post.author }}</span>

          {# Time ago (#3) #}
          {% if post.time_ago %}
          <span>{{ post.time_ago }}</span>
          {% endif %}

          {# Flair tag (#1) #}
          {% if post.flair %}
          <span class="flair">{{ post.flair }}</span>
          {% endif %}

          {# Sentiment badge (#7) #}
          <span class="sentiment-badge sentiment-{{ post.sentiment.css }}">{{ post.sentiment.emoji }} {{ post.sentiment.label }}</span>

          {# Consensus badge (#26) #}
          {% if post.consensus %}
          <span class="consensus-badge consensus-{{ post.consensus.css }}">{{ post.consensus.emoji }} {{ post.consensus.label }}</span>
          {% endif %}

          {# Reading time (#23) #}
          <span class="reading-time">{{ post.reading_time }} min read</span>
        </div>

        {# --- Comments (#2 Enhanced Previews) --- #}
        {% if post.comments and post.comments | length > 0 %}
        <div class="comments-section">
          <div class="comments-count-label">Showing {{ post.comments | length }} of {{ post.num_comments }} comments</div>
          {% for comment in post.comments %}
          <div class="comment{% if comment.is_catalyst is defined and comment.is_catalyst %} catalyst{% endif %}{% if comment.is_creator is defined and comment.is_creator %} creator{% endif %}">
            {# Creator alert (#34) #}
            {% if comment.is_creator is defined and comment.is_creator %}
            <div class="creator-label">Creator Alert</div>
            {% endif %}
            {# Catalyst label (#19) #}
            {% if comment.is_catalyst is defined and comment.is_catalyst %}
            <div class="catalyst-label">Conversation Catalyst</div>
            {% endif %}
            <div class="comment-meta">
              <span>{{ comment.author }}</span>
              <span class="comment-score">&#9650; {{ comment.score }}</span>
            </div>
            <div class="comment-body">{{ comment.body }}</div>
          </div>
          {% endfor %}
        </div>
        {% elif post.comments_degraded %}
        <div class="comments-section">
          <div class="comment" style="color: #6b7280; font-style: italic;">
            Comments unavailable for this thread.
          </div>
        </div>
        {% endif %}
      </div>

      {# --- Action buttons (#8 One-Click Actions + #22 Track + #36 Bookmark) --- #}
      <div class="post-actions">
        <button class="action-btn mark-read-btn" onclick="markRead(this, '{{ post.id }}')">&#10003; Read</button>
        <button class="action-btn hide-btn" onclick="hidePost(this, '{{ post.id }}')">&#10005; Hide</button>
        <button class="action-btn share-btn" onclick="sharePost('{{ post.url }}')">&#128279; Share</button>
        {% if post.show_name %}
        <button class="action-btn track-btn" data-show="{{ post.show_name }}" onclick="toggleTrack(this, '{{ post.show_name }}')">&#9734; Track</button>
        {% endif %}
        <button class="action-btn bookmark-btn" onclick="toggleBookmark(this, '{{ post.id }}', decodeURIComponent('{{ post.title | urlencode }}'), '{{ post.url }}')">&#128278; Save</button>
      </div>
    </div>
    {% endfor %}

    {% if posts | length == 0 %}
    <div class="post" style="text-align: center; color: #6b7280;">
      No high-engagement discussions found today. Check back tomorrow.
    </div>
    {% endif %}

    {# --- Footer (#11, #33) --- #}
    <div class="footer">
      {% if total_comments > 0 %}
      <div class="impact">
        This digest covers {{ "{:,}".format(total_comments) }} comments{% if posts_filtered_out > 0 %} &middot; filtered out {{ posts_filtered_out }} noise posts{% endif %}
      </div>
      {% endif %}
      <div>Generated by <a href="#">The TV Signal</a> &middot; {{ generated_at }}</div>
      <div class="social-proof">Next digest: Tomorrow at 11 PM EST</div>
    </div>

    <script>
    /* ================================================
       Vanilla JS for all interactive features
       localStorage-based, no dependencies
       ================================================ */

    // --- Utility ---
    function getLS(key, def) {
      try { var v = localStorage.getItem('tvs_' + key); return v ? JSON.parse(v) : def; }
      catch(e) { return def; }
    }
    function setLS(key, val) {
      try { localStorage.setItem('tvs_' + key, JSON.stringify(val)); } catch(e) {}
    }

    // --- #4 Smart Filtering ---
    (function initFlairFilters() {
      var flairs = new Set();
      document.querySelectorAll('.post[data-flair]').forEach(function(p) {
        var f = p.getAttribute('data-flair');
        if (f) flairs.add(f);
      });
      var container = document.getElementById('flair-filters');
      flairs.forEach(function(f) {
        var btn = document.createElement('button');
        btn.className = 'filter-btn';
        btn.setAttribute('data-flair', f);
        btn.textContent = f.charAt(0).toUpperCase() + f.slice(1);
        btn.onclick = function() { filterByFlair(f); };
        container.appendChild(btn);
      });
      // Restore saved filter
      var saved = getLS('flair_filter', 'all');
      if (saved !== 'all') filterByFlair(saved);
    })();

    function filterByFlair(flair) {
      document.querySelectorAll('.filter-btn').forEach(function(b) {
        b.classList.toggle('active', b.getAttribute('data-flair') === flair);
      });
      document.querySelectorAll('.post[data-flair]').forEach(function(p) {
        if (flair === 'all' || p.getAttribute('data-flair') === flair) {
          p.style.display = '';
        } else {
          p.style.display = 'none';
        }
      });
      setLS('flair_filter', flair);
    }

    // --- #24 Difficulty Modes ---
    (function initMode() {
      var saved = getLS('read_mode', 'standard');
      setMode(saved);
    })();

    function setMode(mode) {
      document.querySelectorAll('.mode-btn').forEach(function(b) {
        b.classList.toggle('active', b.getAttribute('data-mode') === mode);
      });
      document.body.classList.remove('mode-quick', 'mode-standard', 'mode-deep');
      document.body.classList.add('mode-' + mode);
      setLS('read_mode', mode);
    }

    // --- #8 Mark as Read ---
    (function initRead() {
      var read = getLS('read_posts', []);
      read.forEach(function(id) {
        var el = document.getElementById('post-' + id);
        if (el) {
          el.classList.add('read-post');
          var btn = el.querySelector('.mark-read-btn');
          if (btn) btn.classList.add('active');
        }
      });
    })();

    function markRead(btn, id) {
      var read = getLS('read_posts', []);
      var el = document.getElementById('post-' + id);
      var idx = read.indexOf(id);
      if (idx > -1) {
        read.splice(idx, 1);
        el.classList.remove('read-post');
        btn.classList.remove('active');
      } else {
        read.push(id);
        el.classList.add('read-post');
        btn.classList.add('active');
      }
      setLS('read_posts', read);
    }

    // --- #8 Hide ---
    (function initHidden() {
      var hidden = getLS('hidden_posts', []);
      hidden.forEach(function(id) {
        var el = document.getElementById('post-' + id);
        if (el) el.classList.add('hidden-post');
      });
    })();

    function hidePost(btn, id) {
      var hidden = getLS('hidden_posts', []);
      if (hidden.indexOf(id) === -1) hidden.push(id);
      setLS('hidden_posts', hidden);
      var el = document.getElementById('post-' + id);
      if (el) el.classList.add('hidden-post');
    }

    // --- #8 Share ---
    function sharePost(url) {
      if (navigator.share) {
        navigator.share({ url: url });
      } else if (navigator.clipboard) {
        navigator.clipboard.writeText(url);
      }
    }

    // --- #20 Spoiler Toggle ---
    function toggleSpoiler(el) {
      var content = el.closest('.spoiler-post').querySelector('.spoiler-content');
      content.classList.toggle('revealed');
      el.textContent = content.classList.contains('revealed') ? 'Hide' : 'Show anyway';
    }

    // --- #22 My Shows Tracking ---
    (function initShows() {
      var tracked = getLS('tracked_shows', []);
      refreshShowsPanel(tracked);
      // Highlight tracked and update buttons
      document.querySelectorAll('.post[data-show-name]').forEach(function(p) {
        var show = p.getAttribute('data-show-name');
        if (show && tracked.indexOf(show) > -1) {
          p.classList.add('tracked-show');
          var btn = p.querySelector('.track-btn');
          if (btn) { btn.classList.add('active'); btn.innerHTML = '&#9733; Tracked'; }
        }
      });
    })();

    function toggleTrack(btn, show) {
      var tracked = getLS('tracked_shows', []);
      var idx = tracked.indexOf(show);
      if (idx > -1) {
        tracked.splice(idx, 1);
        btn.classList.remove('active');
        btn.innerHTML = '&#9734; Track';
        btn.closest('.post').classList.remove('tracked-show');
      } else {
        tracked.push(show);
        btn.classList.add('active');
        btn.innerHTML = '&#9733; Tracked';
        btn.closest('.post').classList.add('tracked-show');
      }
      setLS('tracked_shows', tracked);
      refreshShowsPanel(tracked);
    }

    function refreshShowsPanel(tracked) {
      var panel = document.getElementById('my-shows-panel');
      var list = document.getElementById('my-shows-list');
      if (tracked.length === 0) { panel.classList.remove('visible'); return; }
      panel.classList.add('visible');
      list.innerHTML = '';
      tracked.forEach(function(s) {
        var tag = document.createElement('span');
        tag.className = 'my-show-tag';
        tag.textContent = s;
        tag.onclick = function() { toggleTrack(null, s); refreshShowsPanel(getLS('tracked_shows', [])); };
        list.appendChild(tag);
      });
    }

    // --- #36 Bookmarks ---
    (function initBookmarks() {
      refreshBookmarksPanel();
      var bookmarks = getLS('bookmarks', {});
      Object.keys(bookmarks).forEach(function(id) {
        var el = document.getElementById('post-' + id);
        if (el) {
          var btn = el.querySelector('.bookmark-btn');
          if (btn) btn.classList.add('active');
        }
      });
    })();

    function toggleBookmark(btn, id, title, url) {
      var bookmarks = getLS('bookmarks', {});
      if (bookmarks[id]) {
        delete bookmarks[id];
        if (btn) btn.classList.remove('active');
      } else {
        bookmarks[id] = { title: title, url: url };
        if (btn) btn.classList.add('active');
      }
      setLS('bookmarks', bookmarks);
      refreshBookmarksPanel();
    }

    function refreshBookmarksPanel() {
      var bookmarks = getLS('bookmarks', {});
      var keys = Object.keys(bookmarks);
      var panel = document.getElementById('bookmarks-panel');
      var list = document.getElementById('bookmarks-list');
      if (keys.length === 0) { panel.classList.remove('visible'); return; }
      panel.classList.add('visible');
      list.innerHTML = '';
      keys.forEach(function(id) {
        var a = document.createElement('a');
        a.href = bookmarks[id].url;
        a.target = '_blank';
        a.textContent = bookmarks[id].title;
        list.appendChild(a);
      });
    }

    function exportBookmarks() {
      var bookmarks = getLS('bookmarks', {});
      var csv = 'Title,URL\n';
      Object.keys(bookmarks).forEach(function(id) {
        csv += '"' + bookmarks[id].title.replace(/"/g, '""') + '","' + bookmarks[id].url + '"\n';
      });
      var blob = new Blob([csv], { type: 'text/csv' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'tv_signal_bookmarks.csv';
      a.click();
    }
    </script>
  </body>
</html>
